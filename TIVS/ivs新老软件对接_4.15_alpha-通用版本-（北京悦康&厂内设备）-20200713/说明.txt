

2109年05年09日，已经在厂内设备上与老外软件对接，实现仿真检测，动态保存图像序列，离线读取以及保存检测结果。 江登表

4.1 2019年5月14日，实际图像检测已经再程序里面跑起来，可以正常检测，但接口参数还需要再更改，否则需要在代码里面改参数才能使用离线检测程序和在线检测程序。

ver 4.2  2019年5月15日上午，已经加入参数	int nozero_single_thr;  // 单帧粒子上限；int nozero_frm_sum_thr;  // 粒子张数上限； float ratio；检测区域范围。连线测试初步可行

ver4.3 2019年5月15日晚上，加入靠近液面的炫光抑制模块，离线检测程序加入组间播放键盘控制模块。下一步将加入灵敏度使能，以及背景建模方法的实际使用模块。

ver4.5 2019年5月30日，1）通过线程信号量同步，实现检测结果必须在限定时间（如200ms）内返回，否则超时，防止将结果写入plc下一周期；2）通过xml文件来存储和读取图像检测配方（含检测区域roi设置、检测参数设置），当在线储存序列的同时会保存xml格式的检测配方，离线程序可以读取和存储检测配方，从而保证离线和在线的检测结果完全一致（以前做不到）；3）优化离线程序实用体验，如：可以分别控制帧间播放间隔时间和组间播放间隔时间，可以单组图像循环播放；可以将修改的参数即刻测试。

在线存储模块和离线测试程序用途：1）按相机存储序列，若某个相机的剔除率/检测率与其他相机相差较大，则提示该相机光学、相机参数、算法检测参数异常；2）发现算法、机械或光学的共性问题，并给出改进建议；3）通过迭代测试（待检品的合格率，异物品的检出率），结合检测结果序列观测甄别，权衡检测配方。

百克漏检品定性测试：百克灯检工共挑出漏检品116支，包括异物和外观，经我方人员（毛亚鹏）再挑选，排查外观和粒子不可见的产品后得到“明显可见粒子”约， “不明显可见粒子”约。使用与连线检测相同配方（单帧粒子2，图像张数3， 检测比例0.9, 灵敏度1），各重复走三遍，检测情况如下所示：
通过离线测试观测结果序列，大致情况如下：
待检品中的剔除序列可分为两部分：1)主体部分确有粒子轨迹，但人工多数看不到；2)另一部分是底部反光晃动（尤其是液面存在大气泡旋转），瓶子边缘反光，由于这些干扰和真实粒子呈现特性有所交集，为算法区分带来难度。液面的炫光已经加入算法模块过滤，整体效果较好，但对粒子检出性能有所影响。
漏检品重复检测后的机检合格品序列可分为三部分：1)观测不到粒子轨迹；2）粒子可见，但没有达到检测阈值，譬如当前张数为3，但粒子如出现2次，则漏检；3）粒子沉底，或在底部晃动呈现与瓶底反光相似特征。旋瓶延迟应进一步减小，为通过算法改进来区分两者创造更大空间。
总结：
1）难点问题：a）部分比较明显的异物相机拍不到或者过于微弱：要从光学和相机参数设置上加以考虑；b）剔除序列中确有粒子运动轨迹：可能是气泡也有可能是人工看不到粒子，后者需要结合序列澄清，得到客户理解；c）靠近液面炫光散落到瓶身：目前算法已加入炫光抑制模块，效果较好，但会对粒子检测有所影响；d）靠近液面部分灰度变化复杂，且气泡活动频繁，依旧是检测盲区，但目前来看粒子落入盲区的概率较小；e）瓶底受液面晃动而导致的反光，与沉底晃动的粒子呈现特征有交集，对算法提出挑战。f）2ml包材1ml装量，可检测的范围小
2）有利因素：a）检测速度慢，图像序列无晃动；b）包材质量好，没有碎瓶现象，瓶身干净；c）产量低，机械状态良好；d）厂房干净，图像序列中灰尘干扰少；e）小规格包材，相邻工位瓶身干扰较少。


20190614 ver4.6版本说明，苏州东耀实用的版本，已经与王工对接，存在问题：a）靠近液面区域检测不到；b）比较暗的粒子容易漏检；c)复杂的区域容易误检。解决方法：a）检测液面区域亮度范围，动态设置mask；b）设置根据模态动态程度来设置检测阈值的参数。

20190615 ver4.7版本说明，暂时保存，没来得及更新
20190620 ver4.8 版本说明，东耀药业，现场实用版本，更新说明后续补充
20190714 ver4.9 alpha 版本说明，针对广东星昊，厂内测试，未完成，待测试
20190408 ver  版本说明，锦州奥鸿实用
20190721 ver4.9 alpha 版本说明，广东星昊，现场实用版本，合格率较低约为70%，漏检情况尚可接受。还有两种规格未作软件更改
20190721 ver4.9 alpah 版本说明，针对康宝的厂内测试，使用北京德康的设备600瓶，1ml包材1ml装量，使用25mm镜头，图像较大，处理速度有困难。而且瓶身晃动较大，但没有气泡。目前误检较多
20190723 ver4.9 alpha 版本说明，针对康宝的厂内测试，，使用北京德康的设备600瓶，1ml包材1ml装量，使用25mm镜头，图像较大，使用了瓶身定位，但有时定位不准确，导致误检。运算资源不够。
20190725 ver4.9 alpha 版本说明， 下一步考虑：1）按每张图像记录当前的mask区域，若当前像素在当前帧对应的模态已经是满足背景的标准，则不需要mask中标记出来，即检测的时候跳出，减少运算量；2）记录模态的变量次数和模态个数统计图像，对于高于一定阈值的设置为fg图像，fg灰度统计值应当小于总像素个数的60%，若超过这一值则说明图像过亮，或者瓶身过脏。当某张图像发生大范围的模态变化，则说明可能发生位置偏移。若同时发生前景二值图，则将其与模态汇总fg的膨胀图进行比较，若都能覆盖，说明是由偏移导致的，在将其模态变化原图、上下张图相或运算，沿着y方向小幅平移，并与fg模态原图进行比较，看何时能抵消，则说明配准位置正确，再将其与减低检测精度的原图进行再次比较；3）对于炫光干扰的抑制，第一，不需要所有前景都需要判决，对于那些模态次数很高的区域就没有必要，因为这些区域纹理丰富，检测结果不一定好，以及对于远离液面的高瓶身也不需要。第二，炫光干扰是再前景检测的后处理，所以一旦当前帧的前景个数满足前景判决条件，则不需要再进行二值化检测，其他的后处理也遵照相同的原则。4）对于底部缓慢移动的前景，可以考虑使用单个模态进行比较方法，再配合形态学处理，或者将序列张数一分为二，一部分建模则另一部分检测。
20190805 解决了高速600瓶机型的程序异常退出问题，原因是多线程同时释放和获取内存空间太过于频繁，导致超出堆大小限制，这个问题在单线程离线测试显示不出来，必须使用多线程模拟，多达20个左右的多线程模拟才能重新该问题，解决办法是减少不必要的图像深拷贝，对于必须开辟的图像内存，设置为类的成员，让其在生命周期内不再被释放，减少内存频繁新建和释放。此外还遇到一个诡异的问题，就是同样的序列，两次跑得到的roi区域不一样，设置超过原先预设的roi范围，对此一方面要查找原因，防止更大范围的危害，另一方面要严密监控malloc开辟的内存和cv::mat关联的内存之间的大小关系确认。前者务必要大于后者，否则程序异常。为避免过多消耗内存，离线序列保存的缓存从原来的20变为1，离线保存性能下降。当前针对北京悦康，检测性能尚未优化。
20190813 将参数预设放置到xml中，如何去解决该问题呢？分为离线模式和在线检测模式：1）在线检测模式：xml文件通过c盘的指定路径读取；图像保存模式的功能能够即可生效；2）离线模式：xml文件通过读取的文件目录获取；通过界面修改的参数，能够即刻生效；保存参数，则相关参数，包括inter的xml也可以保存到当前目录下；3）图像保存模式：保存检测参数和inter参数的分别两个xml文件。
20190828 昂德生物的厂内使用版本
20190911 国瑞老线10ml现场实用版本，单头部会出现超时问题。
20190926 将国瑞自主软件的兼容版本拷贝过来了，以确认接口再老外程序上是否适用，通过测试。国瑞软件对应版本：D:\sourceCode\guorui\新机器\IVS_fusion600-国瑞第二台灯检机-新接口合并-20190905
20191121 北京悦康实测版本，已经通过客户sat报告，以国瑞老线的接口兼容版本为蓝本，改进方面为：粒子检测使用的背光寻找边缘的方法可以有效定位轮廓所在位置。导致背光算法部分的参数输入无效。
20191121 准备开展复宏汉霖的粒子检测工作。
20191225 应该是复宏汉霖的当前版本，如果有问题，查看svn中修改的部分
20200226 复宏汉霖现场knapp测试版本，粒子检测的pc2版本，但pc1版本有少许微调。检测下过较好，等待现场反馈。下一步：准备尝试不降低检出的前提下，降低误检。
20200229 复宏汉霖： 增加了若干措施降低误检测：1）液面的炫光抑制，仅限于靠近液面的指定高度范围；2）靠近液面很近的范围，以及一张图像大于三次的颗粒，会跳帧一次；3）通过斜率方法找到瓶身边缘。以上减少误检测的方法没有得到客户认可，因为客户更担心的是漏检问题，所以目前软件使用的0226的检测版本。
20200229软件的附属功能，在离线软件imageoffline中增加可以批量导入不同文件夹的功能。
2020306 软件版本，在复宏汉霖4.13-beta版本基础上，开始针对哈药三精的工作，版本命名：4.14_alpha
20190309 准备了在哈药的双黄连版本，主要措施有：1）取消post和dynamic的mask作用，若用到其他版本要恢复回去；2）对结果进行形态学滤波
20200325 哈药的双黄连实用版本，在0309的基础上，增加了裂纹检测部分。目前正在现场实用。
20200402 哈药的蓝钙的粒子检测实用版本。但瓶身检测还需要再测试。
202004010 锦州奥鸿药业的1ml程序版本，增加液面炫光干扰范围可调节的接口，目前现场合格率较低，主要原因是气泡干扰，其他可能的干扰因素正在分项测试。现场1ml实用版本
20200415 开始锦州奥鸿药业2ml程序版本测试
20200508 开始金药1ml红色的测试版本
20200607 通用版本
20200614 原始版本：ivs新老软件对接_4.14_alpha-哈药三精--奥康-20200607 。广东星昊药业，现场当日实用版本，5000多待检品得率69.7%，1000多不良品漏检1支。
20200616 广东星昊版本备份，最终实测版本为20200614版本。
20200713 通用版本