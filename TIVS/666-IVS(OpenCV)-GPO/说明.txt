2109年05年09日，已经在厂内设备上与老外软件对接，实现仿真检测，动态保存图像序列，离线读取以及保存检测结果。 江登表

4.1 2019年5月14日，实际图像检测已经再程序里面跑起来，可以正常检测，但接口参数还需要再更改，否则需要在代码里面改参数才能使用离线检测程序和在线检测程序。

ver 4.2  2019年5月15日上午，已经加入参数	int nozero_single_thr;  // 单帧粒子上限；int nozero_frm_sum_thr;  // 粒子张数上限； float ratio；检测区域范围。连线测试初步可行

ver4.3 2019年5月15日晚上，加入靠近液面的炫光抑制模块，离线检测程序加入组间播放键盘控制模块。下一步将加入灵敏度使能，以及背景建模方法的实际使用模块。

ver4.5 2019年5月30日，1）通过线程信号量同步，实现检测结果必须在限定时间（如200ms）内返回，否则超时，防止将结果写入plc下一周期；2）通过xml文件来存储和读取图像检测配方（含检测区域roi设置、检测参数设置），当在线储存序列的同时会保存xml格式的检测配方，离线程序可以读取和存储检测配方，从而保证离线和在线的检测结果完全一致（以前做不到）；3）优化离线程序实用体验，如：可以分别控制帧间播放间隔时间和组间播放间隔时间，可以单组图像循环播放；可以将修改的参数即刻测试。

在线存储模块和离线测试程序用途：1）按相机存储序列，若某个相机的剔除率/检测率与其他相机相差较大，则提示该相机光学、相机参数、算法检测参数异常；2）发现算法、机械或光学的共性问题，并给出改进建议；3）通过迭代测试（待检品的合格率，异物品的检出率），结合检测结果序列观测甄别，权衡检测配方。

百克漏检品定性测试：百克灯检工共挑出漏检品116支，包括异物和外观，经我方人员（毛亚鹏）再挑选，排查外观和粒子不可见的产品后得到“明显可见粒子”约， “不明显可见粒子”约。使用与连线检测相同配方（单帧粒子2，图像张数3， 检测比例0.9, 灵敏度1），各重复走三遍，检测情况如下所示：
通过离线测试观测结果序列，大致情况如下：
待检品中的剔除序列可分为两部分：1)主体部分确有粒子轨迹，但人工多数看不到；2)另一部分是底部反光晃动（尤其是液面存在大气泡旋转），瓶子边缘反光，由于这些干扰和真实粒子呈现特性有所交集，为算法区分带来难度。液面的炫光已经加入算法模块过滤，整体效果较好，但对粒子检出性能有所影响。
漏检品重复检测后的机检合格品序列可分为三部分：1)观测不到粒子轨迹；2）粒子可见，但没有达到检测阈值，譬如当前张数为3，但粒子如出现2次，则漏检；3）粒子沉底，或在底部晃动呈现与瓶底反光相似特征。旋瓶延迟应进一步减小，为通过算法改进来区分两者创造更大空间。
总结：
1）难点问题：a）部分比较明显的异物相机拍不到或者过于微弱：要从光学和相机参数设置上加以考虑；b）剔除序列中确有粒子运动轨迹：可能是气泡也有可能是人工看不到粒子，后者需要结合序列澄清，得到客户理解；c）靠近液面炫光散落到瓶身：目前算法已加入炫光抑制模块，效果较好，但会对粒子检测有所影响；d）靠近液面部分灰度变化复杂，且气泡活动频繁，依旧是检测盲区，但目前来看粒子落入盲区的概率较小；e）瓶底受液面晃动而导致的反光，与沉底晃动的粒子呈现特征有交集，对算法提出挑战。f）2ml包材1ml装量，可检测的范围小
2）有利因素：a）检测速度慢，图像序列无晃动；b）包材质量好，没有碎瓶现象，瓶身干净；c）产量低，机械状态良好；d）厂房干净，图像序列中灰尘干扰少；e）小规格包材，相邻工位瓶身干扰较少。
